% ######################################################################################################################
\label[sec:xsystem]
\sec The X Window System
% ######################################################################################################################

The X Window System is a network transparent window system that runs on a wide range of computing
and graphics machines~\cite[xman].

In this section, we will cover how the X server works, with a focus on communication with its clients.
We will not cover how the X server handles resources, color, graphics, text, or input as it is not
that important for window management.

\secc History
The X Window System was created in the mid-1980s at the Massachusetts Institute of Technology.
To support further development, a member-funded consortium was formed in 1988,
which was later moved out of MIT, creating an independent, stand-alone organization -- the X Consortium.
All rights to the X Window System were assigned to the X Consortium in 1994.
When the X Consortium closed its doors in 1996, all rights to the X Window System were transferred
to The Open Group (known as the Open Software Foundation).
The X.Org Foundation was formed in 2004 as the successor to the X.Org Group at The Open Group.
The purpose of the X.Org Foundation is to foster the development, evolution, and maintenance of the X Window System.
Membership in the X.Org Foundation is free and open to anyone.
The X.Org Foundation hosts a public git repository of the source code on \url{freedesktop.org}.~\cite[xman2]

The X protocol has been at version 11 since September 1987~\cite[xreleases].
Many revisions have been released since then, the latest one being X11R7.7 released in June 2012~\cite[xreleases].

\label[sec:xarch]
\secc Architecture
The X Window System is based on a client-server model.
The server controls display and input devices, such as keyboard and mouse.
The client is an application that receives input events from the server
and sends output and information requests to the server.
The X architecture allows the clients and the server either to run on the same machine or on different machines
that are connected by a network.~\cite[xguide0]

The window manager is a special X Server client that has control over the layout of windows on the screen.
To enforce this authority, the window manager is using certain X protocol features that will be discussed later on.

\secc The X Protocol
The X Protocol is a standard protocol that is used by the X Window System to exchange information
between the X Server and its clients~\cite[xprotocol].
Information is exchanged by sending messages.
The X protocol defines these four types of messages~\cite[xprotocol]:
\begitems
* Request -- generated by the client and sent to the server.
* Reply -- sent from the server to the client in response to some requests.
* Event -- sent from the server to the client.
* Error -- like an event, but it is handled differently by clients.
\enditems
To get some information about the window, for example, the client can send the "GetProperty" request,
to which server responds with the "GetProperty" reply (or error, eventually).
This could be seen in Listing~\ref[code:xcb].
X Server does not send a reply to all requests, though.
For example, to change the size and location of the window, the client will send the "Configure" request.
This request is processed by the window manager, which sends the "ConfigureNotify" event in response, describing
how the size and location of the window was (or was not) changed.

To receive events, the client must register for them.
When doing so, the client must specify event types that it is interested in, only those will be sent to him by the
X Server.
After initialization, typical X Server client runs an event loop -- an infinite loop that waits for events coming from
the X Server and responds to them.

\label[sec:propertiesatoms]
\secc Properties and Atoms
Properties are arbitrary data attached to the window~\cite[xprotocol].
Each property is characterized by a name, a type, and a value~\cite[xprotocol].
The client can get any property of any window by issuing the "GetProperty" request mentioned before.
The client can also change some properties of its windows, or send "ChangeProperty" request to request property change
of some other client's windows -- only window managers and other special clients (pagers) typically do this.

For example, Table~\ref[tab:properties] shows some of the properties retrieved from
the top-level window of an application using the {\em xprop} utility~\cite[xprop].
We can see, for example, a property named "_NET_WM_DESKTOP" with type "CARDINAL" and value "1".
This property is set by the window manager and tells other clients on which virtual desktop this window resides.
We will discuss the meaning of some significant properties later on in more detail.

Apart from the property name, which is an ASCII string, each property also has a unique integer ID called an {\em atom}.
Atom is just a nickname for a property, so that arbitrary-length property name strings
do not have to be transferred back and forth between the client and the server~\cite[xguide1].
A~property is uniquely identified by an atom and a window~\cite[xguide1].

One of the most important uses of properties is to communicate information from applications to the window manager
and vice versa~\cite[xguide1].
The application sets properties on its top-level window, window manager retrieves them and use them in some way.
For example, application sets the "WM_NAME" property (see Table~\ref[tab:properties])
and window manager will display this name in the title bar of the window.
Another example can be the "_NET_WM_ALLOWED_ACTIONS" -- this one is set by the window manager and
tells the client which actions are supported by the window manager for that specific window.

\midinsert \clabel[tab:properties]{Window properties}
\ctable{ll}{
    Property name and type & Value\crl\tskip4pt
    "WM\_STATE(WM\_STATE)" & window state: Normal \cr
                           & icon window: 0x0 \cr
    "\_NET\_WM\_ALLOWED\_ACTIONS(ATOM)" & "\_NET\_WM\_ACTION\_MOVE, ..." \cr
    "\_NET\_WM\_DESKTOP(CARDINAL)" & 1 \cr
    "\_NET\_WM\_WINDOW\_TYPE(ATOM)" & "\_NET\_WM\_WINDOW\_TYPE\_NORMAL" \cr
    "\_NET\_WM\_STATE(ATOM)" & "\_NET\_WM\_STATE\_MAXIMIZED\_VERT, ..." \cr
    "WM\_PROTOCOLS(ATOM)" & "WM\_DELETE\_WINDOW, WM\_TAKE\_FOCUS" \cr
    "WM\_CLASS(STRING)" & jetbrains-goland, jetbrains-goland \cr
    "\_NET\_WM\_NAME(UTF8\_STRING)" & swm [\char`\~/projects/swm] - .../cmd/swm/main.go \cr
    "WM\_NAME(STRING)" & swm [\char`\~/projects/swm] - .../cmd/swm/main.go \cr
}
\caption/t Window properties retrieved using xprop~\cite[xprop]
\endinsert

\label[sec:xwinhierarchy]
\secc Window Hierarchy

X windows are arranged in a tree hierarchy.
At the top of this hierarchy is so-called {\em root window} that has no parents,
all other windows always have exactly one parent window.
The root window fills the entire screen and is created by the X Server on startup.~\cite[xlibMan]

When a client of the X Server creates its first window, it is created as a child of the root window.
The children of the root window are called top-level windows and those are managed by the window manager.
Each top-level window can also have its own children, but those are managed by the client itself.
Typically, a client creates many windows inside its top-level window to create application features such as buttons
and text boxes.~\cite[xlibMan]

\secc X Client Libraries

Two official helper libraries that provide API for talking to the X Server exist, xlib and XCB~\cite[XlibXCB].

\heading Xlib
Xlib, also known as libX11, is the original C language X11 API, released in 1985.
It was designed to look like a traditional library API, hiding the fact that calls result
in protocol requests to a server.
Calls that don't require a response from the X server are queued in a buffer
to be sent as a batch of requests to the server.
Those that require a response flush all the buffered requests and then
block until the response is received.
This mix of synchronous and asynchronous behavior causes some problems
because it is not obvious which calls implicitly flush the buffer and which do not.\cite[XlibXCB]

\heading XCB
XCB is a second attempt at defining a C language binding for X11.
It was first released in 2001, after many years of experience with Xlib,
learning from it, as well as from other protocol interface libraries.
XCB makes the client-server nature of the protocol explicit in its design.
The client decides when to flush the request buffer,
when to read results, and when to wait for the server to respond.\cite[XlibXCB]

\heading Comparison
In Listings~\ref[code:xlib] and~\ref[code:xcb] (both taken from the official developer's guide~\cite[XlibXCB]),
we can see a comparison of those two libraries on the task of looking up a window property.
Xlib generates the request to the X server to retrieve the property and appends it to its buffer of requests.
Because this type of request requires a response, Xlib flushes the buffer to send its contents to the X Server.
When Xlib receives the reply from the X Server, it returns it to the client.
If there were requests preceding the client's request, the client must wait until the X Server processes all of them.
XCB functions, on the other hand, map directly onto the protocol.
There are separate functions to put requests into the outgoing buffer and to read results back from the X Server.
Thanks to that, one can send many requests to the X Server at once and then wait for all the replies at once,
minimizing the communication overhead.~\cite[XlibXCB]

\codeblock{code:xlib}{Window property lookup using Xlib}{winproperty_xlib.c}{GO}
\codeblock{code:xcb}{Window property lookup using XCB}{winproperty_xcb.c}{GO}

Xlib and XCB are compatible, meaning that one can mix calls to the first with calls to the other.
This compatibility was achieved by rebuilding libX11 as a layer on top of libxcb.
They share the same X server connection and pass control of it back and forth.
That option was introduced in libX11 version 1.2, and since version 1.4, released in 2010, it is always present
(not only optional).\cite[XlibXCB]

Most applications should call Xlib and XCB sparingly, and rather utilize higher-level toolkits that provide
more efficient programming models~\cite[XlibXCB].
Window managers have to usually call XCB or Xlib directly, though.
For the implementation of swm, we used the X Go Binding library~\cite[xgb], which is Go wrapper of XCB.
We will talk about it in more detail in Chapter~\ref[chap:impl].
